generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Persona {
  id          Int         @id @default(autoincrement())
  nombre      String
  apellido    String
  dni         String?
  telefono    String?
  direccion   String?
  fechaNac    DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  citas       Cita[]
  empleado    Empleado?
  expedientes Expediente?
  user        User?
}

model User {
  id        Int      @id @default(autoincrement())
  correo    String   @unique
  password  String?
  rol       Rol      @default(CLIENTE)
  activo    Boolean  @default(true)
  personaId Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  persona   Persona  @relation(fields: [personaId], references: [id])
}

model Empleado {
  id                   Int                 @id @default(autoincrement())
  personaId            Int                 @unique
  puesto               Puesto
  salario              Float
  fechaIngreso         DateTime            @default(now())
  activo               Boolean             @default(true)
  citas                Cita[]
  persona              Persona             @relation(fields: [personaId], references: [id])
  archivosCreados      ExpedienteArchivo[]
  detalles             ExpedienteDetalle[]
  expedientesAsociados ExpedienteDoctor[]
}

model ServicioClinico {
  id          Int      @id @default(autoincrement())
  nombre      String
  descripcion String?
  precio      Float
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  citas       Cita[]
}

model Expediente {
  id                Int                 @id @default(autoincrement())
  pacienteId        Int                 @unique
  alergias          String?
  enfermedades      String?
  medicamentos      String?
  observaciones     String?
  activo            Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  paciente          Persona             @relation(fields: [pacienteId], references: [id])
  archivos          ExpedienteArchivo[]
  detalles          ExpedienteDetalle[]
  doctoresAsociados ExpedienteDoctor[]
}

model ExpedienteDoctor {
  expedienteId    Int
  doctorId        Int
  fechaAsociacion DateTime   @default(now())
  doctor          Empleado   @relation(fields: [doctorId], references: [id], onUpdate: NoAction)
  expediente      Expediente @relation(fields: [expedienteId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([expedienteId, doctorId])
}

model ExpedienteDetalle {
  id              Int        @id @default(autoincrement())
  expedienteId    Int
  fecha           DateTime
  motivo          String?
  diagnostico     String?
  tratamiento     String?
  planTratamiento String?
  doctorId        Int
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  doctor          Empleado   @relation(fields: [doctorId], references: [id])
  expediente      Expediente @relation(fields: [expedienteId], references: [id])
}

model ExpedienteArchivo {
  id            Int        @id @default(autoincrement())
  expedienteId  Int
  nombreArchivo String
  tipoArchivo   String?
  creadoPorId   Int
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  filePath      String
  storageName   String     @unique
  creadoPor     Empleado   @relation(fields: [creadoPorId], references: [id])
  expediente    Expediente @relation(fields: [expedienteId], references: [id])
}

model Cita {
  id                       Int                       @id @default(autoincrement())
  fecha                    String
  estado                   EstadoCita                @default(PENDIENTE)
  pacienteId               Int
  doctorId                 Int
  servicioId               Int
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  hora                     String
  doctor                   Empleado                  @relation(fields: [doctorId], references: [id])
  paciente                 Persona                   @relation(fields: [pacienteId], references: [id])
  servicio                 ServicioClinico           @relation(fields: [servicioId], references: [id])
  HistorialCancelacionCita HistorialCancelacionCita?
}

model HistorialCancelacionCita {
  id                Int      @id @default(autoincrement())
  citaId            Int      @unique
  motivoCancelacion String
  usuarioCancelaId  Int
  rolCancela        String   @db.VarChar(50)
  fechaCancelacion  DateTime @default(now()) @db.Timestamptz(6)
  Cita              Cita     @relation(fields: [citaId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

enum Rol {
  ADMIN
  DOCTOR
  RECEPCIONISTA
  CLIENTE
}

enum Puesto {
  DOCTOR
  RECEPCIONISTA
  ADMINISTRADOR
  OTRO
}

// ------------------ SERVICIO CLINICO ------------------
model ServicioClinico {
  id              Int              @id @default(autoincrement())
  nombre          String
  descripcion     String?
  precio          Float
  activo          Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  citas           Cita[]           // Un servicio puede estar en muchas citas
}

// ------------------ EXPEDIENTE ------------------
model Expediente {
  id            Int      @id @default(autoincrement())
  pacienteId    Int      @unique // Solo 1 expediente por paciente
  paciente      Persona  @relation(fields: [pacienteId], references: [id])
  doctorId      Int
  doctor        Empleado @relation(fields: [doctorId], references: [id])

  alergias      String?
  enfermedades  String?
  medicamentos  String?
  observaciones String?

  activo        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  detalles      ExpedienteDetalle[]
  archivos      ExpedienteArchivo[]
}

// ------------------ EXPEDIENTE DETALLE ------------------
model ExpedienteDetalle {
  id                Int       @id @default(autoincrement())
  expedienteId      Int
  expediente        Expediente @relation(fields: [expedienteId], references: [id])

  fecha             DateTime
  motivo            String?
  diagnostico       String?
  tratamiento       String?
  planTratamiento   String?

  doctorId          Int
  doctor            Empleado  @relation(fields: [doctorId], references: [id])

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ------------------ EXPEDIENTE ARCHIVO ------------------
model ExpedienteArchivo {
  id               Int      @id @default(autoincrement())
  expedienteId     Int
  expediente       Expediente @relation(fields: [expedienteId], references: [id])

  nombreArchivo    String 
  filePath     String
  storageName  String @unique

  tipoArchivo      String? 
  creadoPorId      Int
  creadoPor        Empleado @relation(fields: [creadoPorId], references: [id])

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ------------------ CITA ------------------
model Cita {
  id          Int          @id @default(autoincrement())
  fecha       String
  estado      EstadoCita   @default(PENDIENTE)
  hora        String       
  pacienteId  Int
  paciente    Persona      @relation(fields: [pacienteId], references: [id])
  doctorId    Int
  doctor      Empleado     @relation(fields: [doctorId], references: [id])
  servicioId  Int
  servicio    ServicioClinico @relation(fields: [servicioId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

}

enum EstadoCita {
  PENDIENTE
  COMPLETADA
  CANCELADA
  CONFIRMADA
}

enum HorarioLaboral {
  H08_00
  H08_30
  H09_00
  H09_30
  H10_00
  H10_30
  H11_00
  H11_30
  H13_00
  H13_30
  H14_00
  H14_30
  H15_00
  H15_30
  H16_00
  H16_30
}
